---
layout: post
title:  "计算机网络学习笔记四 网络层"
date:   2020-07-20 06:00:00
categories: 计算机网络
tags: 计算机网络 网络层
mathjax: true
mermaid: false
---

* content
{:toc}

本篇主要包括网络层的相关介绍，网络层提供的两种服务，网际协议IP，划分子网，网际控制报文协议ICMP，互联网的路由选择协议，IPv6，IP多播，虚拟专用网VPN和网络地址转换NAT。



## 网络层提供的两种服务
* 长期争论交点：网络层是否提供可靠交互，是由网络层负责还是由端系统负责。
* 两种服务：虚电路服务，数据报服务
* 目前，网络层提供简单灵活、无连接的、尽最大努力交付的数据报服务。不提供服务质量承诺。
* 降低网络成本，运行方式灵活，能适应多种应用。

## 网际协议 IP
* 网际协议IP 是TCP/IP体系中最重要的协议之一。
* 与IP配套使用的还有三个协议：<font color = "red" size = "4">地址解析协议 ARP</font>Address Resolution Protocal，<font color="red" size="4">网际控制报文协议ICMP</font>Internet Control Message Protocol，<font color="red" size="4">网际组管理协议IGMP</font>Internet Group Management Protocol。

### IP互连网络
* 网际协议Internet Protocol，互连使用同一网际协议的计算机网络看成虚拟互连网络。使用IP协议让原本各异的网络看起来是同一的网络，所以IP协议的虚拟互连网简称IP网。


### 分类的IP地址
* IP协议的虚拟互连网通过IP地址实现在网络上如何寻址。
* IP地址的编址方式有三个历史阶段：分类的IP地址，子网的划分，构成超网。
* 分类的IP地址如图所示
<figure align="center">
  <img src="/media/image/IPcomposition.png" width="544" height="384" />
</figure>
* IP地址中一般不使用的特殊IP地址

| 网络     | 主机号         | 源地址 | 目的地址 | 含义                   |
|:-------|:------------|:----|:-----|:---------------------|
| 0      | 0           | 可以  | 不可   | 在本网络上的本主机            |
| 0      | host-id     | 可以  | 不可   | 在本网络上的某个主机host-id    |
| 全1    | 全1          | 不可  | 可以   | 只在本网络上进行广播(各路由器均不转发) |
| net-id | 全1          | 不可  | 可以   | 对net-id上的所有主机进行广播    |
| 127    | 非全0或全1的任何数字 | 可以  | 可以   | 对本地软件环回测试只用          |

* 特点：每个IP地址都由网络号和主机号两部分组成。1.管理机构仅分配网络号，路由器根据网络号来转发分组减小资源和时间消耗。2.网络号的不同标识着不同的网络，相同网络号则在同一个局域网内。因此多归属主机则至少由两个不同的IP地址(其中网络号是不同的)，路由器也至少由两个不同的IP地址。3.通过转发器或网桥连起来的若干个局域网仍然是一个网络，由同样的网络号。4.任何网络无论大小，分配网络号的网络均是等价的。

### IP地址与硬件地址
* 硬件地址(物理地址)是数据链路层和物理层使用的地址。
* IP地址是网络层和以上各层使用的地址，是逻辑地址(IP地址是用软件实现的)。
* IP地址在IP数据报的首部，而硬件地址在MAC帧的首部。
* IP地址与硬件地址关系图:

<figure align="center">
  <img src="/media/image/LayersofDataFlow.png" width="579" height="279" />
</figure>

### 地址解析协议 ARP
* 地址解析协议ARP解决IP地址与本地主机或路由器MAC地址间的对应关系。
* 解决方案：ARP高速缓存，存储局域网的IP和MAC地址,TTL(Time To Live)有效映射时间表。
* 同一局域网下，A向B通讯，则查ARP高速缓存，有则直接生成MAC帧;无则广播ARP请求分组，目标机B则向A单播告诉其MAC地址。
* 主要解决异构网络MAC地址不一样，复杂MAC地址的分级、分组路由算法等不好实现的问题。可通过IP编址利用计算机软件自动实现ARP的过程，主机用户(及应用层和运输层)不知道地址解析过程。

### IP数据报的格式
* IP数据报由首部和数据组成。首部包含20字节固定长度和可选字段。
* 固定部分中包括版本(目前IPv4，4位)，生存时间(占8位，通过路由器的最大数目，Time To Live)，协议(占8位，区分数据使用的协议便于目的主机将数据交给指定进程，如网络层的ICMP, IGMP, OSPF, 运输层的TCP, UDP)
* 可选部分用于排错、测量及安全等措施，长度1-40字节。由于增加开销，一般使用。

### IP层转发分组的流程
* 路由器的路由表是使用网络地址来制作的。
* 路由表中每条路由主要包含两个信息：(目的网络地址, 下一跳地址)。
* 只有到达最后一个路由器时，才试图向目的主机交付。
* 分组转发算法：
   1.从数据报首部提取目的主机IP地址D，得到网络地址N。
   2.若网络N直接相连，通过ARP解析封装MAC帧直接交付，终止。
   3.D在路由表中有特定主机路由，则下一跳特定主机路由，终止。
   4.路由表中有到达N网络的路由或到达N网络的下一跳路由，则执行下一跳，终止。
   5.路由表有默认路由，则下一跳默认路由，终止。
   6.报告转发出错。

## 划分子网

### 划分子网
* 两级IP地址设计不合理：IP地址空间利用率有时低；每个物理网络分配一个网络号使得路由表过大，网络性能变差；两级网络地址不够灵活，构建新的小网络比较麻烦。
* 因此将host-id划分为subnet-id子网号字段和host-id两部分。从两级IP地址变成三级IP地址，叫做划分子网。整个网络对外依然表现为没有划分子网的情况。

### 子网掩码
* IP数据报首部无法判断网络是否子网划分，使用子网掩码可以快速找出IP地址子网部分。
* 子网掩码长度与IP地址长度一样，1则对应IP地址中的网络号和子网号部分，0对应主机号部分。“与”运算可快速查询子网号。
* 分组转发算法发生变化：
   1.从数据报首部提取目的主机IP地址D。
   2.先用各网络的子网掩码和 D 逐位相“与”，看是否和相应的网络地址匹配。，终止。
   3.D在路由表中有特定主机路由，则下一跳特定主机路由，终止。
   4.路由表中每一行的子网掩码与D作“与”运算，结果与目的网路地址匹配，则执行下一跳，终止。
   5.路由表有默认路由，则下一跳默认路由，终止。
   6.报告转发分组出错。

## 网际控制报文协议ICMP
* Internet Control Message Protocol 是为有效转发IP数据报提高交付成功几率，使用的网际控制报文协议，属于IP层协议，不属于高层协议。
* 分为ICMP差错报告报文和ICMP询问报文。
* ICMP报文中的IP数据报报文部分(前面还有IP数据报首部)前四个字节固定格式：类型、代码和校验和。接着四个字节的内容与ICMP的类型有关，最后是数据字段也和类型有关。

### ICMP报文的种类  
#### ICMP差错报告报文
* ICMP差错报告报文分为五种：终点不可达，源点抑制，时间超过(TTL为0和预定时间内不能收到一个数据报的全部报文片), 参数问题，改变路由(重定向)。 
* 差错报告报文结构如图所示：
* 特殊情况不发送ICMP差错报告报文：ICMP差错报告报文的数据报，分片数据报的后续报片不发送，多播数据报，有特殊地址的数据报(127.0.0.0或0.0.0.0)

#### ICMP询问报文
* 回送请求和回答：询问特定的目的主机了解其状态；时间戳请求和回答：请求某个主机或路由器回答当前日期和时间，用于时钟同步和测量时间。

### ICMP的应用实例
#### PING Packet InterNet Groper
* 用于测试两主机间的连通性；PING使用了ICMP回送请求与回送回答报文；是应用层直接使用网络层ICMP的例子，没有经过运输层的TCP和UDP。
* 格式：Ping + 地址

#### Traceroute应用
* Unix系统下是Traceroute，Windows下是tracert，用于跟踪一个分组从源到终点的路径。
* 利用IP数据报中的TTL字段和ICMP时间超过差错报告报文实现对源点到重点路径的跟踪。
* 格式：Traceroute/tracert + 地址

## 互连网的路由选择协议

### 几个基本概念
* 理想的路由算法：正确、简单、自适应、稳定公平、最佳。实际上最佳路由算法仅仅是特定要求下较为合理的选择而已。
* 路由选择问题的复杂性：它是所有结点共同协调工作的结果，路由的选择往往是不断变化的，这种变化无法实现知道。
* 两大路由选择协议：内部网关协议(IGP Interior Gateway Protocol)和外部网关协议(EGP External Gateway Protocol)
* 自洽系统之间的路由选择叫做域间路由选择，自洽系统内部的路由选择叫做域内路由选择。
* 常用的内部网关协议：路由信息协议RIP，OSPF协议；外部网关协议EGP，BGP-4。

### 内部网关协议RIP
* 路由信息协议RIP，Routing Information Protocol 是一种分布式的、基于距离向量的路由选择协议。要求每一个路由器都要维护一个自己到其他每一个网络的距离记录(直接连接为1，每跳一次+1，距离之最短距离，最大距离为15，最大值为16时相当于不可达)。
* RIP协议特点：
   1. 仅和相邻的路由器交换信息；
   2. 交换的信息是当前路由器知道的全部信息；
   3. 按照固定时间间隔交换路由信息。
* 特点：好消息传播快，坏消息传播慢(相互传递较好的消息，屏蔽了本身的坏消息，导致坏消息更新慢)。
* 距离向量算法的基础是Bellman-Ford算法（或Ford-Fulkerson算法）。

### 内部网关协议OSPF
* 开放最短路径优先OSPF(Open Shortest Path First)
* OSPF协议特点：
   1. 向本自洽系统中所有路由器发送信息；
   2. 发送的信息仅是与本路由相邻的所有路由器的链路状态；
   3. 只有链路状态发送变化时，才用洪泛法发送此信息。