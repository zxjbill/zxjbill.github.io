---
layout: post
title:  "计算机网络学习笔记五 运输层"
date:   2020-07-22 06:00:00
categories: 计算机网络
tags: 计算机网络 运输层
mathjax: true
mermaid: false
---

* content
{:toc}

本篇主要包括运输层的相关介绍，运输层协议概述、UDP、TCP和TCP传输的一些具体内容。



## 运输层协议概述
### 进程之间的通信
* 传输层提供了主机应用程序进程之间端到端的服务。
* 只有位于网络边缘的主机的协议栈才由运输层，而中心部分的路由器转发分组只用到下三层。
* 网络层：为主机之间提供逻辑通信。运输层：为<font color = "red">应用进程之间</font>提供端到端的逻辑通信。
* 一台主机多个应用进程同时分别和另一台主机的多个应用进程通信。则涉及到<font color = "red">IP复用和IP分用</font> 。
* 应用程序的不同需求，运输层有两种不同协议：<font color = "red">面向连接的TCP协议</font>和<font color = "red">无连接的UDP协议</font>。

### 运输层的两个主要协议
* 传送的数据单位均为：运输协议数据单元TPDU，Transport Protocol Data Unit。
* 用户数据报协议UDP，User Datagram Protocol
* 传输控制协议TCP，Transmission Control Protocol
* UDP：传输数据<font color = "red">不需要建立连接</font>。传送的数据单位协议是<font color = "red">UDP报文</font>。收到UDP报文后不需要给出任何确认，<font color = "red">不提供可靠交付</font>。
* TCP：面向连接的服务。传送的数据单位协议是<font color = "red">TCP报文段(segment)</font>。因此<font color = "red">不提供多播和广播服务</font>。提供可靠、面向连接的运输服务，<font color = "red">增加开销</font>。

### 运输层的端口
* 计算机进程有进程标识符，但运行在应用层上的应用进程不应当由计算机操作系统指派进程标识符。
* 解决问题的方法是运输层使用协议端口号(protocol port number), 简称<font color = "red">端口port</font>。
* 端口号是一个16位数，<font color = "red">仅具有本地意义</font>，标注本计算机应用层的各进程。所以找到进程需要知道对方计算机的IP地址和对方进程的端口号。
* 端口号分为两大类：
  * 服务器端口：熟知端口，登记端口号(无熟知端口号对应的应用程序，所以使用需要登记放重复)。
  * 客户端使用的端口号：又称短暂端口号49152及以上。通信结束后归还端口号，其他进程可使用。

## 用户数据报协议UDP
### UDP概述
* UDP只在IP数据报服务基础增加了很少的功能：复用和分用的功能，差错检测的功能。
* UDP特点：
  * UDP 是<font color = "red">无连接的</font>。
  * UDP使用尽最大努力交付;不保证可靠交付。
  * UDP是面向报文的。
    * 对应用层交下来的报文既不合并也不拆分，保留报文边界，一次性交付完整报文。
    * 应用程序必须选择合适的报文长度，太长或太短都不利于IP层的效率(太长会IP层分片，太短IP层头部占比过大)。
  * UDP没有拥塞控制，出现拥塞也不会降低源主机发送速率，对实时应用很重要。
  * UDP支持一对一，一对多，多对一和多对多通信。
  * UDP的首部开销小，仅需8字节。

### UDP的首部格式
* UDP首部8字节包含：源端口，目的端口，长度，检验和。各2字节。
* UDP基于端口的分用：运输层从IP层获得UDP数据，更具部首中的端口把UDP数据上交给最后终点应用程序。
* UDP检验：把伪部首增加到UDP用户数据报前计算检验和。伪部首部分12字节：源IP(4字节)，目的IP(4字节)，0(1字节)，17(1字节，IP数据报首部中协议字段的值，UDP所以是17)，UDP用户数据报长度(2字节，包括UDP首部长度+UDP数据长度)。另外UDP数据报最后要补全4字节的整数倍(补全的0不计入UDP用户数据报长度)。
* 检验方法是<font color = "red">二进制反码运算求和</font>，具体步骤如下：
  1. 每两个字节一个数，求反码；(计算检验和字段时，检验和字段看成0)
  2. 反码相加，相加结果最高位如果进位，则在结果最低位加1。
  3. 计算检验和字段：所有数字按照1-2步骤相加得到结果，填入检验和字段位置。
  4. 检验和字段检验：添加伪首部，添加补全0，按照步骤1-2计算所有数字和，数字和全为1则通过，不是则丢弃。

## 传输控制协议TCP概述
### TCP 主要特点：
* TCP面向连接：每条TCP连接只能由两个端点，只能是点对点的。
* TCP提供可靠交付的服务。
* TCP提供全双工通信。
* 面向字节流：
  * “流”(stream)指的是流入或流出进程的字节序列；
  * “面向字节流”：进程和TCP交互是一次一个数据块，但TCP把应用程序交下来的数据看成一串无结构的字节流。
  * TCP接受放应用程序收到的字节流必须和发送放应用程序发出的字节流<font color = "red">完全一样</font>。
  * TCP不关心应用进程一次把多长的报文发送给TCP缓存。TCP对连续的字节流分段，形成TCP报文段。
  * TCP根据<font color = "red">窗口值</font>和<font color = "red">当前网络的阻塞</font>决定一个报文的字节数。(UDP的报文长度则由<font color = "red">应用进程</font>决定)
  * 所以TCP可以划分数据库发送，也可以积累足够字节后发送。

### TCP的连接
* TCP连接的端点叫做套接字(Socket)或插口。<font color = "red">端口号拼接到IP地址即构成了套接字</font>，套接字$socket = (IP地址:端口)$，$TCP连接::={socket1, socket2}={(IP1:port1), (IP2:ports)}$。

## 可靠传输的工作原理
* 理想的传输条件具有两个特点：
  * 传输信道不产生差错。
  * 无论多快的发送速度，接收方总来得及处理。

### 停止等待协议