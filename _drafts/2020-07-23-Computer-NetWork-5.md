---
layout: post
title:  "计算机网络学习笔记五 运输层"
date:   2020-07-22 06:00:00
categories: 计算机网络
tags: 计算机网络 运输层
mathjax: true
mermaid: false
---

* content
{:toc}

本篇主要包括运输层的相关介绍，运输层协议概述、UDP、TCP和TCP传输的一些具体内容。



## 运输层协议概述
### 进程之间的通信
* 传输层提供了主机应用程序进程之间端到端的服务。
* 只有位于网络边缘的主机的协议栈才由运输层，而中心部分的路由器转发分组只用到下三层。
* 网络层：为主机之间提供逻辑通信。运输层：为<font color = "red">应用进程之间</font>提供端到端的逻辑通信。
* 一台主机多个应用进程同时分别和另一台主机的多个应用进程通信。则涉及到<font color = "red">IP复用和IP分用</font> 。
* 应用程序的不同需求，运输层有两种不同协议：<font color = "red">面向连接的TCP协议</font>和<font color = "red">无连接的UDP协议</font>。

### 运输层的两个主要协议
* 传送的数据单位均为：运输协议数据单元TPDU，Transport Protocol Data Unit。
* 用户数据报协议UDP，User Datagram Protocol
* 传输控制协议TCP，Transmission Control Protocol
* UDP：传输数据<font color = "red">不需要建立连接</font>。传送的数据单位协议是<font color = "red">UDP报文</font>。收到UDP报文后不需要给出任何确认，<font color = "red">不提供可靠交付</font>。
* TCP：面向连接的服务。传送的数据单位协议是<font color = "red">TCP报文段(segment)</font>。因此<font color = "red">不提供多播和广播服务</font>。提供可靠、面向连接的运输服务，<font color = "red">增加开销</font>。

### 运输层的端口
* 计算机进程有进程标识符，但运行在应用层上的应用进程不应当由计算机操作系统指派进程标识符。
* 解决问题的方法是运输层使用协议端口号(protocol port number), 简称<font color = "red">端口port</font>。
* 端口号是一个16位数，<font color = "red">仅具有本地意义</font>，标注本计算机应用层的各进程。所以找到进程需要知道对方计算机的IP地址和对方进程的端口号。
* 端口号分为两大类：
  * 服务器端口：熟知端口，登记端口号(无熟知端口号对应的应用程序，所以使用需要登记放重复)。
  * 客户端使用的端口号：又称短暂端口号49152及以上。通信结束后归还端口号，其他进程可使用。

## 用户数据报协议UDP
### UDP概述
* UDP只在IP数据报服务基础增加了很少的功能：复用和分用的功能，差错检测的功能。
* UDP特点：
  * UDP 是<font color = "red">无连接的</font>。
  * UDP使用尽最大努力交付;不保证可靠交付。
  * UDP是面向报文的。
    * 对应用层交下来的报文既不合并也不拆分，保留报文边界，一次性交付完整报文。
    * 应用程序必须选择合适的报文长度，太长或太短都不利于IP层的效率(太长会IP层分片，太短IP层头部占比过大)。
  * UDP没有拥塞控制，出现拥塞也不会降低源主机发送速率，对实时应用很重要。
  * UDP支持一对一，一对多，多对一和多对多通信。
  * UDP的首部开销小，仅需8字节。

### UDP的首部格式
* UDP首部8字节包含：源端口，目的端口，长度，检验和。各2字节。
* UDP基于端口的分用：运输层从IP层获得UDP数据，更具部首中的端口把UDP数据上交给最后终点应用程序。
* UDP检验：把伪部首增加到UDP用户数据报前计算检验和。伪部首部分12字节：源IP(4字节)，目的IP(4字节)，0(1字节)，17(1字节，IP数据报首部中协议字段的值，UDP所以是17)，UDP用户数据报长度(2字节，包括UDP首部长度+UDP数据长度)。另外UDP数据报最后要补全4字节的整数倍(补全的0不计入UDP用户数据报长度)。
* 检验方法是<font color = "red">二进制反码运算求和</font>，具体步骤如下：
  1. 每两个字节一个数，求反码；(计算检验和字段时，检验和字段看成0)
  2. 反码相加，相加结果最高位如果进位，则在结果最低位加1。
  3. 计算检验和字段：所有数字按照1-2步骤相加得到结果，填入检验和字段位置。
  4. 检验和字段检验：添加伪首部，添加补全0，按照步骤1-2计算所有数字和，数字和全为1则通过，不是则丢弃。

## 传输控制协议TCP概述
### TCP 主要特点：
* TCP面向连接：每条TCP连接只能由两个端点，只能是点对点的。
* TCP提供可靠交付的服务。
* TCP提供全双工通信。
* 面向字节流：
  * “流”(stream)指的是流入或流出进程的字节序列；
  * “面向字节流”：进程和TCP交互是一次一个数据块，但TCP把应用程序交下来的数据看成一串无结构的字节流。
  * TCP接受放应用程序收到的字节流必须和发送放应用程序发出的字节流<font color = "red">完全一样</font>。
  * TCP不关心应用进程一次把多长的报文发送给TCP缓存。TCP对连续的字节流分段，形成TCP报文段。
  * TCP根据<font color = "red">窗口值</font>和<font color = "red">当前网络的阻塞</font>决定一个报文的字节数。(UDP的报文长度则由<font color = "red">应用进程</font>决定)
  * 所以TCP可以划分数据库发送，也可以积累足够字节后发送。

### TCP的连接
* TCP连接的端点叫做套接字(Socket)或插口。<font color = "red">端口号拼接到IP地址即构成了套接字</font>，套接字$socket = (IP地址:端口)$，$TCP连接::={socket1, socket2}={(IP1:port1), (IP2:ports)}$。

## 可靠传输的工作原理
* 理想的传输条件具有两个特点：
  * 传输信道不产生差错。
  * 无论多快的发送速度，接收方总来得及处理。

### 停止等待协议
* 无差错情况：“停止等待”指每发送完一个分组就停止发送，等待对方确认，确认后发送下一个分组。
* 出现差错分：为两种情况：
  * 情况一：接收到分组数据报，但检测出差错，丢弃，但接收方其他什么都不做。
  * 情况二：接收方没有收到数据。
  * 解决方案：<font color = "red">超时重传</font>，每个分组设置计时器，超时没收到则重发。
* 确认丢失和确认迟到：
  * 发送方收到重复确认，丢弃，不处理。
  * 接收方收到重复数据报，也丢弃，<font color = "red">但重新传送确认分组</font>。
* 按照上述传输方式的可靠传输协议通常称为<font color = "red">自动重传请求ARQ, Automatic Repeat reQuest</font>。重传请求是自动进行的，接收方不需要请求发送重传。
* <font color = "red">信道利用率$U$</font>：$T_D$发送分组的发送时延，$RTT$往返传播时延, $T_A$确认消息的发送时延
  
  <div class = "post-container">
  $$
  U = \frac{T_D}{T_D+RTT+T_A}
  $$
  </div>

* 为提高效率，采用了流水线传输：发送方不必发完每个分组都等待确认，连续发送多个分组。一直有数据传输，所以提高了信道利用率。

### 连续ARQ协议
* 发送方维持<font color="red">发送窗口</font>：位于发送窗口内的分组可以连续发送出去，而不需要等待对方确认。
* 连续ARQ协议规定，发送方每收到一个确认，窗口向前滑动一个分组的位置。
* 接收方采用<font color = "red">积累确认</font>方式。不逐个分组发送确认，对按序到达的最后一个分组发送确认，表示所有分组已收到。优点：容易实现，丢失不必重传。缺点：不能反映接收方已经正确收到的分组信息。
* <font color="red">Go-back-N</font>:表示退回重传已发送过的N个分组(即使N个分组中的后几个分组正确传送了)。因此当通信线路质量不好时，连续ARQ协议带来负面影响。

## TCP报文段的首部格式
* TCP报文首部：20个字节的固定首部和4n个根据需要增加的选项($\in N$)。具体如图所示：

<figure align="center">
  <img src = "/media/image/TCPComposition.png" width="551" height="320" />
</figure>

* <span style="color:red;">端口字段</span>：总共4字节，运输层与应用层的服务接口，运输层的复用和分用功能通过端口得以实现。
* <span style="color:red;">序号字段</span>：4字节，指本报问所发第一个字节的在数据流中的序号。32位长度表示。
* <span style="color:red;">确认号字段</span>：4字节，期望对方下一个报文段的数据第一个字节的序号。(这是根据己方之前正确接收数据的最大序号+1，4个字节则有4GB的数据，所以一般重复利用时，老序号数据早已到达终点)
* 数据偏移字段：1个字节，指出TCP报文段中，TCP首部长度(TCP数据部分开头相对于TCP报文段开头的偏移量)。1个字节所以也会影响到选项长度。
* <span style="color:red;">窗口字段</span>：2字节，让对方设置发送窗口的依据。(往往根据己方接受窗口大小/数据缓存空间有关)
* <span style="color:red;">检验和字段</span>：2字节，检验和字段检验范围包括首部和数据两部分。计算是应该添加TCP报文段的前面12字节的伪首部(与UDP相似，但第四个字段协议号是TCP协议号6，第五个字段是TCP长度)。使用IPv6时相应的伪首部也要变化。
* 另外有六个控制位说明报文段的性质：紧急URG(配合紧急指针使用)，确认ACK(链接建立后，为1),推送PSH，复位RST(一般由于出错，或拒绝会使用，用于释放重连)，同步SYN(配合ACK用于建立连接)，终止FIN(释放连接)。
* 选项：最长40字节。由$(2^4 - 1)*4$个4字节长度决定，除去固定首部得到40字节。

## TCP可靠传输的实现
### 以字节为单位的滑动窗口
* 字节为单位的滑动窗口，与发送方接受方的缓存量有关，和读取写入速度有关，与网络质量也有关。
* 注意的问题：
  * 发送窗口是根据对方的接受窗口设定，但由于网络有滞后性，所以两者窗口并不是一样大，发送方可能要根据网络拥塞情况适当减小自己的发送窗口。
  * 不按需到达的数据，TCP协议并无明确规定。但均丢弃对网络资源利用不利。大多数情况TCP会临时存放，等缺少的字符收到后，再<font color = "red">按序上交</font>。
  * TCP要求接受方<font color = "red">一定要有累积确认功能</font>。不应过分推迟，规定推迟确认时间不超过0.5s.捎带确认信息的TCP数据报并不常见，因为"全双工工作"的状态不常见。

### 超时重传时间的选择
* 重传时间的选择时TCP最复杂的问题之一。受互联网环境影响，运输层往返时间(RTT)方差很大。
* TCP采用自适应算法计算往返时间RTT的加权平均往返时间$RTT_s$(又称平滑的往返时间)。
* 加权平均往返时间$RTT_S$计算公式(除第一次，直接去样本值)。其中RFC2988推荐$\alpha$取0.125。
  <div class = "post-container">
  $$
  RTT_S = (1-\alpha) \times RTT_s + \alpha \times 新样本RTT
  $$
  </div>
* Karn算法：报文重传则计入往返时间RTT的样本。
* 修正的Karn算法：报文重传一次，则重算一次RTT，$RTT = \gamma \times RTT$, $\gamma$典型值为2。不发生重传时，才正常跟新加权平均往返时间。

### 选择确认SACk
* 未按序号接受的正确数据，是否可确认：可以，解决方案：<font color = "red">选择确认SACK</font> Selective ACK。
* 在TCP首部中选项部分，指明SACK选项(1字节)和SACK选项长度(1字节), 每段以确定数据的(上下边界, 8字节)，所以最多能指明4个已确认的为按序号字节快。
* RFC 2018要求在<span style="color:red;">建立TCP连接</span>时，应该在首部选项中加上“允许SACK”选项，事先商量好。