---
layout: post
title:  "深入理解计算机系统学习笔记四"
date:   2020-08-27 21:53:00
categories: 操作系统
tags: CS:APP 存储器层次结构
mathjax: true
mermaid: false
excerpt_separator: <!--more-->
---

* content
{:toc}
本篇主要关于存储器系统 memory system。主要了解基本的存储技术，并描述它们如何被组织成层次结构的。高速缓存存储器的使用。C 程序的局部性。“存储器山”。

<!--more-->

## 存储计数
### 随机访问存储器
* 随机访问存储器 Random-Access Memory RAM：分为静态 SRAM 和动态 DRAM 两类。静态 RAM 更贵。
* 静态 SRAM：存在双稳态 bistable，可无限期地保持在两个不同的电压配置或状态。电路会恢复到稳态值。
* 动态 DRAM：由一个电容和一个访问晶体管组成。将电位存储为一个对小电容的充电。对干扰敏感，被扰乱后永不恢复。
  
#### 传统的 DRAM：
* DRAM 芯片中的单元被分为 d 个超单元 supercell，每个超单元都由 w 个 DRAM 单元组成。一般称为“单元”，或一个“字”，这里叫做“超单元”。
* 每个 DRAM 芯片与内存控制器链接，可一次在 CPU 和 DRAM 址间传送 w 位。
* 通过行地址 Row Access Strobe 和列地址 Column Access Strobe 两个请求量来实现 DRAM 的地址访问。会有内部行缓冲区，作为某行到某个单元个的转换。

#### 内存模块
* DRAM 芯片封装在内存模块中，再插到主板上。以64位为块传送数据到内存控制器和从内存控制器传入数据。

#### 增强的 DRAM
* 快页模式 Fast Page Mode DRAM：如果两个访问是在同一行，则可仅去除一次整行数据。
* 扩展数据输出 Extended Data Out DRAM
* 同步 Synchronous DRAM：比上述两种异步的存储器更快的输出超单元的内容。
* 双倍数据速率同步 DRAM Double Data-Rate Synchronous DRAM，DDR SDRAM：两个时钟作为控制信号，使得 DRAM 速度翻倍。
* 视频 RAM Vidieo RAM：与 FPM DRAM 类似。

#### 非易失性储存器
* SRAM 和 DRAM 都是断电就丢失信息，所以是易失性 volatile 的储存器。
* 只读存储器 Read-Only Memory ROM。虽然有的类型能被重编程（写），但由于历史原因也叫作 ROM。主要根据可被写次数及机制来区分。
  * PROM Programmable ROM 可编程 ROM，仅可编程一次。
  * 可擦写可编程 ROM Erasable Programmable ROM EPROM 可反复擦写达到1000次数量级。
  * 电子可擦除 EROM Electrially Erasable PROM EEPROM 可直接印刷到电路卡上编程，可被编程次数达到100000数量级。
  * 闪存 flash memory 其中固态硬盘也是一种基于闪存的磁盘驱动器。
* 存储在 ROM 中的程序通常称为固件 firmware。例如 PC 的 BIOS (基本输入/输出系统) 例程。复杂设备像图像卡和磁盘驱动控制器也需要来自固件翻译来自 CPU 的 I/O 请求。

#### 访问主存
* 数据流在处理器和 DRAM 主存之间来回是通过被称为总线 bus 的共享电子电路完成的。完成传送的步骤称为总线事务 bus transaction。
* 总线有系统总线，内存总线，I/O 总线。
* I/O 桥：将系统总线的电子信号翻译成内存总线的电子信号。并且也将系统总线、内存总线连接到 I/O 总线上。磁盘和显卡等 I/O 设备都共享 I/O 总线。
* CPU 执行内存加载操作的步骤。写也是类似的。
  * CPU 将地址放到系统总线，I/O 桥将信号传输到内存总线。
  * 主存接收内存总线信号，从 DRAM 的对应地址中取出数据字，并写到内存总线，由I/O桥将其翻译为系统总线信号。
  * CPU 接收到系统总线上的数据，读取数据赋值到相应寄存器。

### 磁盘存储
* 盘片、表面、主轴、旋转速率(Revolution Per Minute RPM)。
* 磁道、扇区、扇区间隙(标识扇区格式化位)
* 一般称为磁盘驱动器，简称磁盘，也称为旋转磁盘，区别于基于闪存的固态硬盘 SSD。SSD 没有移动部分。
* 磁盘容量：记录密度、磁道密度、面密度
* 磁盘操作：通过读/写头实现，通过传动臂移动实现读写头寻道完成。
* 逻辑磁盘块：磁盘封装，并通过磁盘控制器维护着逻辑块号和物理磁盘扇区之间的映射关系。
* 连接 I/O 设备：例如 Intel 的外围设备互连 Peripheral Component Interconnect PCI 总线连接到 CPU 和主存。主要不同的类型的设备L：
  * 通用串行总线 Universal Serial Bus USB，USB3.0 最高带宽为 625 MB/s，USB3.1 为 1250 MB/s。
  * 图形卡
  * 主机总线适配器：连接一个或多个磁盘。通常由 SCSI 和 SATA 两种，前者更快也更贵。
  * 其他设备，例如网络适配器等。

### 固态硬盘
* Solid State Disk，SSD：利用闪存芯片替代传统旋转磁盘中的机械驱动器，而闪存翻译层是一个固件设备，扮演与磁盘控制器相同的角色，将逻辑块的请求翻译成对物理设备的访问。
* 由于平均磨损逻辑处理得较好，一般 SSD 需要多年才会磨损坏。

## 局部性
* 良好的程序常常具有良好的局部性。
  * 时间局部性：被引用过的内存位置，很可能在不远的将来再次发生引用。
  * 空间局部性：被引用过的内存位置，在不远的将来可能引用其附近的位置。
* 局部性原理运行通过引入<span style="color:red">高速缓存存储</span>的小而快速的存储器保存最近被使用的指令和数据项。

### 对数据引用的局部性
* 重复引用相同变量的程序具有良好的时间局部性。
* 数组步长为 k 的引用模式，其中随 k 增大，空间局部性下降。
* 体现到二维数组 `a[M][N]` 的遍历中，先对 `M` 进行索引，比先对 `N` 索引的空间局部性要好。

### 取指令的局部性
* 指令一般顺序执行。同时循环体一般也有很好的时间局部性和空间局部性，循环体越小，迭代次数越多，局部性越好。

## 存储器层次结构
* 存储器的层次结构：寄存器，L1 高速缓存（SRAM），L2 高速缓存（SRAM），L3 高速缓存（SRAM），主存（DRAM），本地二级存储（本地磁盘），远程二级磁盘（分布式文件系统、Web服务器）。

### 存储器层次结构中的缓存
* 高速缓存 cache 作为低速设备中数据对象的缓冲区域，使用高速缓存的过程一般称为缓存。
* 常需要考虑缓存命中和缓存不命中情况。
* 缓存不命中可能需要进行替换或驱逐，需要合适的替换策略。最近最少被使用 LRU 替换策略。
* 冷不命中（强制不命中）：缓存中为空，没有存放导致不命中。
* 冲突不命中：由于某个放置策略引起的不命中。
* 容量不命中：工作集的大小超过缓存的大小时引起不命中。
* 每一层次的存储器都是下一层次存储设备的缓存。一般缓存管理逻辑时硬件、软件或两者相结合的。

## 高速缓存存储器
### 通用的高速缓存存储器组织结构
* 高速缓存通用组织：(S, E, B, m)。存储器地址有 m 位，高速缓存有 $S = 2 ^ s$ 个高速换成组，每个组包含 E 个缓存行，每行由一个 $B = 2 ^ b$ 字节的数据块组成。每行具有一个有效位，和 $t = m - s -b$ 个标记位，唯一标识存储在这个高速缓存行中的块。
* 高速缓存容量$C = B \times E \times S$。不包含有效位，标记位等开销。

### 直接映射高速缓存
* 每组仅有一行 $E = 1$ 的高速缓存称为直接映射缓存器。
* 请求步骤分为三步：
  * 组选择：通过地址中的 s 位选择。
  * 进行行匹配：使用地址中的 t 位与标识位进行匹配。同时此时设置的有效值必须是有效。
  * 取出命中或不命中时进行行替换。
* 直接映射高速缓存的冲突不命中：发生冲突不命中的情况，可通过调整数组大小来缓解这一情况。
* 一般以地址中间的s位作为组索引，这样可以使得<span style="color:red">相邻的块总是映射到不同的高速缓存行</span>。

### 组相联高速缓存
* 组相联高速缓存：每个组保存多余一个的高速缓存行 $1 < E < C/B$，通常称为 E 路组相联高速缓存。

### 全相连高速缓存
* 全相联高速缓存：仅包含一个组，该组包含所有高速缓存行，即 $s = 0$。
* 高速缓存电路必须并行收缩许多相匹配的标记位，所以构造一个又大又快的的相连高速缓存很困难，成本也高。所以只适用于小的高速缓存，例如虚拟内存系统中的翻译备用缓冲器。

### 有关写的问题
* 命中后的处理方式：
  * 直写：立即将字的高速缓存块写回到紧接着的第一层。增加了总线流量。
  * 写回：尽可能延迟更新，只有当替换算法要驱逐这个更新时，才将其写入到更低一层。减少了总线流量，但增加了复杂度，需要维护一个额外的修改位，表明该高速缓存块是否被修改过。
* 不命中处理：
  * 写分配，加载低一层的高速缓存，并更新这个高速缓存块。
  * 非写分配：避开高速缓存，直接将数据写入到第一层中。

### 真实的高速缓存层次结构的解剖
* 现代处理器包括独立的指令高速缓存 i-cache 和 数据高速缓存 d-cache。
* Intel Core i7 处理器的每个核心包含自己私有的 L1 高速缓存，由 L1 i-cache 和 L1 d-cache 组成，也包含私有的 L2 统一高速缓存。而所有核心共享 L3 统一的高速缓存。所有的 SRAM 高速缓存器都在 CPU 上。

### 高速缓存参数的性能影响
* 不命中率：不命中数量/引用数量。
* 命中率
* 命中时间：高速缓存传送一个字数据到 CPU 的时间。一般对于 L1 高速缓存需要几个时钟周期。
* 不命中除法：L1 不命中通常 10 个周期；L2 不命中需要 50 个周期，L3 不命中则需要 200 个时钟周期。
* 影响因素：高速缓存 C 大小的影响，块大小 B 的影响，相联度 E 的影响，写策略的影响。

## 编写高速缓存友好的代码
* 让最常见的情况运行得快。
* 尽量减小每个循环内部得缓存不命中数量。
* 局部变量得反复引用是好的。
* 步长为 1 的引用模式是好的。多维数组的空间局部性尤为重要。

## 综合：高速缓存对程序性能的影响
### 存储器山
* 读吞吐量：一个程序从存储系统中读数据的速率。有时称为读带宽。
* 每个计算机都有能够读带宽的时间和空间局部性二维函数，称为存储器山。

### 重新排列循环以提高空间局部性
* 矩阵乘法中考虑乘法迭代顺序。 $C = AB$，由于迭代顺序不同，会产生六个版本。
* 采用 $kij \And ikj (BC)$ 的模式可以得到一个较好折中，使得 A 不会发送不命中，而 B 和 C 都仅发生较少不命中。但同时每个循环增加了一次存储次数。

```cpp
// kij 版本
for (k = 0; k < n; k++){
  for (i = 0; i < n; i++){
    r = A[i][k];
    for (j = 0; j < n; j++){
      C[i][j] += r * B[k][j];
    }
  }
}

// ikj 版本
for(i = 0; i < n; i++){
  for (k = 0; k < n; k++){
    r = A[i][k];
    for (j = 0; j < n; j++){
      C[i][j] += r * B[k][j];
    }
  }
}
```

* 当矩阵规模增大后，采用 $ikj$ 和 $kij$ 两种模式会明显加快计算速率。
* 相同不命中数量的版本对应大致相同的测量性能。
* 不命中率比内存访问总数对性能影响更大。
* 当数组规模增大后，最快的两个版本性能基本保持不变，虽然数组远大于 SRAM 高速缓存存储器。这是由于硬件预取机制足够好，以至于能够认出步长为 1 的访问模式，速度上满足了内循环的内存访问。因此空间局部性得到更好的应用。
* 分块可提高时间局部性。

### 在程序中利用局部性
* 推荐的技术
  * 内循环优化，大部分计算和内存访问都发生在内循环上。
  * 数据对象存储在内存中的顺序以步长为1的来读取数据，提高程序空间局部性。
  * 一旦存储器读入一个数据对象，尽可能多利用它，从而使得程序中的时间局部性最大。