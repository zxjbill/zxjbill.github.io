---
layout: post
title:  "计算机网络学习笔记四 网络层"
date:   2020-07-20 06:00:00
categories: 计算机网络
tags: 计算机网络 网络层
mathjax: true
mermaid: false
---

* content
{:toc}

本篇主要包括网络层的相关介绍，网络层提供的两种服务，网际协议IP，划分子网，网际控制报文协议ICMP，互联网的路由选择协议，IPv6，IP多播，虚拟专用网VPN和网络地址转换NAT。



## 网络层提供的两种服务
* 长期争论交点：网络层是否提供可靠交互，是由网络层负责还是由端系统负责。
* 两种服务：虚电路服务，数据报服务
* 目前，网络层提供简单灵活、无连接的、尽最大努力交付的数据报服务。不提供服务质量承诺。
* 降低网络成本，运行方式灵活，能适应多种应用。

## 网际协议 IP
* 网际协议IP 是TCP/IP体系中最重要的协议之一。
* 与IP配套使用的还有三个协议：<font color = "red" size = "4">地址解析协议 ARP</font>Address Resolution Protocal，<font color="red" size="4">网际控制报文协议ICMP</font>Internet Control Message Protocol，<font color="red" size="4">网际组管理协议IGMP</font>Internet Group Management Protocol。

### IP互连网络
* 网际协议Internet Protocol，互连使用同一网际协议的计算机网络看成虚拟互连网络。使用IP协议让原本各异的网络看起来是同一的网络，所以IP协议的虚拟互连网简称IP网。


### 分类的IP地址
* IP协议的虚拟互连网通过IP地址实现在网络上如何寻址。
* IP地址的编址方式有三个历史阶段：分类的IP地址，子网的划分，构成超网。
* 分类的IP地址如图所示
<figure align="center">
  <img src="/media/image/IPComposition.png" width="544" height="384" />
</figure>
* IP地址中一般不使用的特殊IP地址

| 网络     | 主机号         | 源地址 | 目的地址 | 含义                   |
|:-------|:------------|:----|:-----|:---------------------|
| 0      | 0           | 可以  | 不可   | 在本网络上的本主机            |
| 0      | host-id     | 可以  | 不可   | 在本网络上的某个主机host-id    |
| 全1    | 全1          | 不可  | 可以   | 只在本网络上进行广播(各路由器均不转发) |
| net-id | 全1          | 不可  | 可以   | 对net-id上的所有主机进行广播    |
| 127    | 非全0或全1的任何数字 | 可以  | 可以   | 对本地软件环回测试只用          |

* 特点：每个IP地址都由网络号和主机号两部分组成。1.管理机构仅分配网络号，路由器根据网络号来转发分组减小资源和时间消耗。2.网络号的不同标识着不同的网络，相同网络号则在同一个局域网内。因此多归属主机则至少由两个不同的IP地址(其中网络号是不同的)，路由器也至少由两个不同的IP地址。3.通过转发器或网桥连起来的若干个局域网仍然是一个网络，由同样的网络号。4.任何网络无论大小，分配网络号的网络均是等价的。

### IP地址与硬件地址
* 硬件地址(物理地址)是数据链路层和物理层使用的地址。
* IP地址是网络层和以上各层使用的地址，是逻辑地址(IP地址是用软件实现的)。
* IP地址在IP数据报的首部，而硬件地址在MAC帧的首部。
* IP地址与硬件地址关系图:

<figure align="center">
  <img src="/media/image/LayersofDataFlow.png" width="579" height="279" />
</figure>

### 地址解析协议 ARP
* 地址解析协议ARP解决IP地址与本地主机或路由器MAC地址间的对应关系。
* 解决方案：ARP高速缓存，存储局域网的IP和MAC地址,TTL(Time To Live)有效映射时间表。
* 同一局域网下，A向B通讯，则查ARP高速缓存，有则直接生成MAC帧;无则广播ARP请求分组，目标机B则向A单播告诉其MAC地址。
* 主要解决异构网络MAC地址不一样，复杂MAC地址的分级、分组路由算法等不好实现的问题。可通过IP编址利用计算机软件自动实现ARP的过程，主机用户(及应用层和运输层)不知道地址解析过程。

### IP数据报的格式
* IP数据报由首部和数据组成。首部包含20字节固定长度和可选字段。
* 固定部分中包括版本(目前IPv4，4位)，生存时间(占8位，通过路由器的最大数目，Time To Live)，协议(占8位，区分数据使用的协议便于目的主机将数据交给指定进程，如网络层的ICMP, IGMP, OSPF, 运输层的TCP, UDP)
* 可选部分用于排错、测量及安全等措施，长度1-40字节。由于增加开销，一般使用。

<figure align="center">
  <img src="/media/image/IPv4DataGram.png" width="430" height="203" />
</figure>

### IP层转发分组的流程
* 路由器的路由表是使用网络地址来制作的。
* 路由表中每条路由主要包含两个信息：(目的网络地址, 下一跳地址)。
* 只有到达最后一个路由器时，才试图向目的主机交付。
* 分组转发算法：
   1.从数据报首部提取目的主机IP地址D，得到网络地址N。
   2.若网络N直接相连，通过ARP解析封装MAC帧直接交付，终止。
   3.D在路由表中有特定主机路由，则下一跳特定主机路由，终止。
   4.路由表中有到达N网络的路由或到达N网络的下一跳路由，则执行下一跳，终止。
   5.路由表有默认路由，则下一跳默认路由，终止。
   6.报告转发出错。

## 划分子网

### 划分子网
* 两级IP地址设计不合理：IP地址空间利用率有时低；每个物理网络分配一个网络号使得路由表过大，网络性能变差；两级网络地址不够灵活，构建新的小网络比较麻烦。
* 因此将host-id划分为subnet-id子网号字段和host-id两部分。从两级IP地址变成三级IP地址，叫做划分子网。整个网络对外依然表现为没有划分子网的情况。

### 子网掩码
* IP数据报首部无法判断网络是否子网划分，使用子网掩码可以快速找出IP地址子网部分。
* 子网掩码长度与IP地址长度一样，1则对应IP地址中的网络号和子网号部分，0对应主机号部分。“与”运算可快速查询子网号。
* 分组转发算法发生变化：
   1.从数据报首部提取目的主机IP地址D。
   2.先用各网络的子网掩码和 D 逐位相“与”，看是否和相应的网络地址匹配。，终止。
   3.D在路由表中有特定主机路由，则下一跳特定主机路由，终止。
   4.路由表中每一行的子网掩码与D作“与”运算，结果与目的网路地址匹配，则执行下一跳，终止。
   5.路由表有默认路由，则下一跳默认路由，终止。
   6.报告转发分组出错。

## 网际控制报文协议ICMP
* Internet Control Message Protocol 是为有效转发IP数据报提高交付成功几率，使用的网际控制报文协议，属于IP层协议，不属于高层协议。
* 分为ICMP差错报告报文和ICMP询问报文。
* ICMP报文中的IP数据报报文部分(前面还有IP数据报首部)前四个字节固定格式：类型、代码和校验和。接着四个字节的内容与ICMP的类型有关，最后是数据字段也和类型有关。

### ICMP报文的种类  
#### ICMP差错报告报文
* ICMP差错报告报文分为五种：终点不可达，源点抑制，时间超过(TTL为0和预定时间内不能收到一个数据报的全部报文片), 参数问题，改变路由(重定向)。 
* 差错报告报文结构如图所示：
* 特殊情况不发送ICMP差错报告报文：ICMP差错报告报文的数据报，分片数据报的后续报片不发送，多播数据报，有特殊地址的数据报(127.0.0.0或0.0.0.0)

#### ICMP询问报文
* 回送请求和回答：询问特定的目的主机了解其状态；时间戳请求和回答：请求某个主机或路由器回答当前日期和时间，用于时钟同步和测量时间。

### ICMP的应用实例
#### PING 应用
* Packet InterNet Groper：用于测试两主机间的连通性；PING使用了ICMP回送请求与回送回答报文；是应用层直接使用网络层ICMP的例子，没有经过运输层的TCP和UDP。
* 格式：Ping + 地址

#### Traceroute应用
* Unix系统下是Traceroute，Windows下是tracert，用于跟踪一个分组从源到终点的路径。
* 利用IP数据报中的TTL字段和ICMP时间超过差错报告报文实现对源点到重点路径的跟踪。
* 格式：Traceroute/tracert + 地址

## 互连网的路由选择协议

### 几个基本概念
* 理想的路由算法：正确、简单、自适应、稳定公平、最佳。实际上最佳路由算法仅仅是特定要求下较为合理的选择而已。
* 路由选择问题的复杂性：它是所有结点共同协调工作的结果，路由的选择往往是不断变化的，这种变化无法实现知道。
* 两大路由选择协议：内部网关协议(IGP Interior Gateway Protocol)和外部网关协议(EGP External Gateway Protocol)
* 自洽系统之间的路由选择叫做域间路由选择，自洽系统内部的路由选择叫做域内路由选择。
* 常用的内部网关协议IGP：路由信息协议RIP，OSPF协议；外部网关协议EGP，BGP-4。

### 内部网关协议RIP
* 路由信息协议RIP，Routing Information Protocol 是一种分布式的、基于距离向量的路由选择协议。要求每一个路由器都要维护一个自己到其他每一个网络的距离记录(直接连接为1，每跳一次+1，距离之最短距离，最大距离为15，最大值为16时相当于不可达)。
* RIP协议三个要点：
   1. 仅和相邻的路由器交换信息；
   2. 交换的信息是当前路由器知道的全部信息；
   3. 按照固定时间间隔交换路由信息。
* 特点：好消息传播快，坏消息传播慢(相互传递较好的消息，屏蔽了本身的坏消息，导致坏消息更新慢)。
* 距离向量算法的基础是Bellman-Ford算法（或Ford-Fulkerson算法）。

### 内部网关协议OSPF
* 开放最短路径优先OSPF(Open Shortest Path First)
* OSPF协议三个要点：
   1. 向本自洽系统中所有路由器发送信息；
   2. 发送的信息仅是与本路由相邻的所有路由器的链路状态(说明本链路与哪些链路相连，及与该链路的"度量")；
   3. 只有链路状态发送变化时，才用洪泛法发送此信息。
* 为了更好的运用于大规模网络，对自洽系统进行划分，得到若干个小范围，叫做区域，每个区域有32位区域标识符。(区域内路由器个数<200为佳)洪泛法则仅需要更新区域内的路由器发送信息，减小通信量。
* OSPF协议特点：
   1. OSPF协议对不同类型的业务可计算不同的路由(不同类型的业务有不同的代价)。
   2. 相同目的网络可能有多条代价相同的路径，可将通信量分配个几条路径，多路径间的负载均衡。
   3. 支持可变长度的子网划分和无分类的编制CIDR。
   4. 每条链路状态都有32位的序号。序号越大状态越新。
   5. OSPF分组有鉴别功能。

### 外部网关协议BGP
* Border Gateway Protocol：不同自洽系统的路由器间交换信息的协议。比较新的版本BGP-4。
* BGP寻找的时比较好的路由(不兜圈子)，而并非寻找最佳路由。
* 每个自洽系统的管理员至少有一个路由作为“BGP发言人”。
* BGP发言人间交换路由i西南西，要建立TCP连接，交换BGP报文已建立BGP会话，用BGP会话交换路由器信息。
* BGP协议特点：
  1. BGP发言人数目少网络不致于过分复杂；
  2. BGP交换路由信息的结点数量要比自洽系统中的网络数少很多；
  3. BGP刚运行时BGP的邻站交换整个BGP路由表，但随后仅更新有变化部分。

## IPv6
### 基本首部及其他数据报结构
* IPv6主要变化：更大地址空间128bit，扩展的地址层次结构，灵活的首部，改进的选项(放入有效载荷内)，允许协议继续扩充，支持即插即用(自动配置)，支持资源预分配。
* IPv6数据报由两部分组成：基本首部(40字节)和有效载荷(有效载荷包含0个或多个扩展首部和数据部分，总长不超过64KB)。

<figure align="center">
  <img src="/media/image/IPv6DataGram.png" width="378" height="300" />
</figure>

* 各个字段作用举例：有效载荷长度：占16位，指明除基本首部外的字节数目。下一个部首：有扩展首部类型则指明下一个扩展首部类型，没有则指明高层协议(例如TCP或UDP等)。
* 六种类型扩展首部：逐跳选项，路由选择，分片，鉴别，封装安全有效载荷和目的站选项。
* 扩展首部举例：分片扩展首部：源点选取最小MTU或发送前完成路径最大传送单元发现(Path MTU Discovery)，确保路径中数据报片长度小于路径中的MTU。在拓展首部中会包含下一部首、片偏移、标识符、M值(指明是否是最后一报片)等字段。
* 考虑到最大传输单元问题，IPv6不能随便采用新路径。原路径故障，采用新路径，如果新路径MTU小于原有路径MTU，需要采用隧道技术来传送。将现有数据封装成多个新IPv6数据报片，不改变原有的基本首部和拓展首部内容，到终点后再重新封装得到原来的数据报。

### IPv6的地址
* IPv6的目的地址分为以下三类：单播，多播，任播(任播的目的站是一组计算机，但交付时只交付其中一个，通常是距离最近的那个)。
* 冒号16进制记法：
    * IPv6中每个地址128位，地址空间大于<span class = "post-container">$3.4\times 10^{38}$</span>
    * 每十六个位之间用冒号隔开，一个十六位用一个四位十六进制数表示。允许省略四位十六进制数的前导0。示例：68E6:8C64:FFFF:FFFF:0:1180:960A:FFFF。
    * 支持零压缩：一连串冒号0可省略，但任意一个地址仅能一次零压缩。示例：FF05:0:0:0:0:0:0:B3可压缩为FF05::B3。
    * 可与点分十进制记法结合。示例：0:0:0:0:0:0:128.10.2.1压缩为::128.10.2.1

### 从IPv4向IPv6过渡
* 只能逐步演进，并且还要保证新安装的IPv6向后兼容：IPv6系统能够接受和转发IPv4分组，并能为IPv4分组选择路由。
* 过渡策略：双协议栈，隧道技术。
* 双协议栈：利用具有双协议栈的主机(或路由器)在连接不同IP类型主机或路由时采用不同协议栈，不同协议栈间转换，会改变首部。从IPv4到IPv6转换时，会出现部分首部字段丢失的情况。
* 隧道技术：利用双协议站主机将"整个IPv6数据报"作为数据部分报完全封装成IPv4数据报，并在IPv4局域网中传播(此时源主机和目的主机分别时两端的双协议站主机)。到大目的站端的双协议站主机再将数据报恢复成IPv6数据报。

### ICMPv6
* IPv6也不保证数据可靠交付，所以也需要ICMP来反馈差错信息。
* ICMPv6包括了类似IPv4中的IGMP和ARP协议功能。

## IP多播
### IP多播的基本概念
* IP多播(也称为组播)：更好的支持一对多通信。不同局域网时，路由器实现复制分组。同一局域网，硬件多播功能，无需复制分组。
* 多播IP地址：IP地址前四位为1110紧接着五位不用后接剩下23位。一个D类地址对应一个多播组，只能用于目的地址，不能用于源地址。
* 多播数据报：使用D类地址作为目的地址，首部的协议字段使用值是2，表明使用网际组管理协议IGMP。“尽最大努力交付”，但不保证多播组内成员都能得到交付。不产生ICMP差错报文。

### 网际组管理协议IGMP和多播路由器选择协议
* 网际组管理协议IGMP Internet Group Management Protocol：可使得路由器知道多播组成员的信息。
* IGMP协议：让连接到<font color = "red">本局域网上</font>的多播路由器知道本局域网上是否有主机参加或退出了某个多播组。
* IGMP分为两阶段：
   1. 加入多播组：主机向多播组多播地址发送IGMP报文，声明自己要成为该组成员，本地多播路由器收到IGMP报文后，将组成员关系转发给互联网上其他多播路由器。
   2. 探询组成员变化情况：本地多播路由器周期性地探询本地局域网上的主机，知道其是否继续是组成员。只要有一个主机响应，该组则活跃，几次探询都没有任何响应则不再将该组成员关系转发给其他多播路由器。
* 多播路由选择协议：局域网的多播路由器和互联网上的多播路由器协同工作，以便以最小代价送给所有组成员。
* 多播路由选择协议：实际是找出以源主机为根节点的多播转发树。目前协议尚未标准化。
* 多播路由选择协议在转发多播数据报时使用的三种方法：
  * 洪泛与剪除：采用反向路径广播策略。路由器发现下游树枝没有多播组成员则剪除它和下游树枝。适用于临近的局域网有较小而共同多播组。
  * 隧道技术：将整个多播数据报完全封装(包括首部)在单播IP数据报中，传递到目标网络后，在恢复成多播数据报。适用于多播组分散的情况。
  * 基于核心的发现技术：每个多播组有一个核心路由器，给出它的IP单播地址，核心路由器创建除对应于多播组的转发树。适用于多播组大小在较大范围内变化的情况。

## 虚拟专用网VPN和网络地址转换NAT
### 虚拟专用网VPN
* IP地址紧缺，互联网并不安全。如果机构计算机内部通信也采用TCP/IP协议，那么在机构内部可以自行分配其IP地址。
* 虚拟专用网Virtual Private Network：利用公共网络作为机构各专用网之间的通信载体。
* 专用网：是因为本机构内部通信。虚拟：并没有实际通信专线。经常用隧道技术实现虚拟专用网的通信。

### 网络地址转换NAT
* 解决专用网使用专用地址的主机如何与互联网上的主机通信(并不需要加密)？解决方案
  * 再申请一些全球IP地址；一般不容易做到。
  * 采用网络地址转换NAT。
* 网络地址转换 NAT Network Address Translation：在专用网连接到互联网的路由器上安装NAT软件，成为NAT路由器(至少有一个有效的全球IP地址)。
* 与外界通信时，都由NAT路由器将本地地址转换成全球IP地址。